<%- include("../adminLayouts/header.ejs") %>
    <%- include("../adminLayouts/sidenavbar.ejs") %>

    <style>

        .div1{
            width: 100px;
            margin-left: 20px;
            margin-top: 10px;
        }

    </style>
        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">
                    <form class="searchform">
                        <div class="input-group">
                            <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
                            <button class="btn btn-light bg" type="button"><i
                                    class="material-icons md-search"></i></button>
                        </div>
                        <datalist id="search_terms">
                            <option value="Products"></option>
                            <option value="New orders"></option>
                            <option value="Apple iphone"></option>
                            <option value="Ahmed Hassan"></option>
                        </datalist>
                    </form>
                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
                            class="material-icons md-apps"></i></button>
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link btn-icon" href="#">
                                <i class="material-icons md-notifications animation-shake"></i>
                                <span class="badge rounded-pill">3</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn-icon darkmode" href="#"> <i
                                    class="material-icons md-nights_stay"></i> </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="requestfullscreen nav-link btn-icon"><i
                                    class="material-icons md-cast"></i></a>
                        </li>
                        <li class="dropdown nav-item">
                            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage"
                                aria-expanded="false"><i class="material-icons md-public"></i></a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                                <a class="dropdown-item text-brand" href="#"><img src="assets/imgs/theme/flag-us.png"
                                        alt="English" />English</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-fr.png"
                                        alt="Français" />Français</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-jp.png"
                                        alt="Français" />日本語</a>
                                <a class="dropdown-item" href="#"><img src="assets/imgs/theme/flag-cn.png"
                                        alt="Français" />中国人</a>
                            </div>
                        </li>
                        <li class="dropdown nav-item">
                            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount"
                                aria-expanded="false"> <img class="img-xs rounded-circle"
                                    src="assets/imgs/people/avatar-2.png" alt="User" /></a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                                <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit
                                    Profile</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account
                                    Settings</a>
                                <a class="dropdown-item" href="#"><i
                                        class="material-icons md-account_balance_wallet"></i>Wallet</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help
                                    center</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#"><i
                                        class="material-icons md-exit_to_app"></i>Logout</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </header>
            <section class="content-main">
                <div class="container" style="background-color: white;">

                    <div>
                        
                        <h4><i class="fa-solid fa-calendar-days" style="font-size: 20px;"></i> <%= orderData.currendDate.toLocaleDateString('en-US', { day: 'numeric' , month: 'short' ,year: 'numeric' }) %></h4>
                        
                        <p style="font-size: 18px;">OrderID: # <%= orderData.orderId %></p>
                        <br>
                        
                        <hr>

                    </div>
                    <div>
                        <h4><i class="fa-solid fa-user"></i>  Customer</h4>
                        <br>
                        <% if(orderData.address[0]){ %>
                            <p style="font-size: 18px;"><%= orderData.address[0].name %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].city %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].district %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].state %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].country %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].pincode %></p>
                            <p style="font-size: 18px;"><%= orderData.address[0].mobile %></p>
                            <hr>
                       <%  } %>

                        
                        
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr style="background-color: #306450; color: white;">
                                    <th>Product</th>
                                    <th></th>
                                    <th>UnitPrice</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Manage</th>
                                </tr>
                            </thead>
                            <tbody>
    
                                <% if(orderData.items.length> 0){ %>
                                    <% orderData.items.forEach(product=> { %>
    
    
                                        <tr style="color: black;">
                                            
                                            <td>
                                                <img style="width: 50px; height: 50px;" src="<%= product.productId.image[0] %> " alt="asdasdf" >
                                                
                                            </td>

                                            <td>
                                                <p><%= product.productId.pname %> </p>
                                            </td>

                                            <td>
                                                <p><%= product.productId.price %> </p>
                                            </td>

                                            <td>
                                                <p><%= product.quantity %> </p>
                                            </td>

                                            <td>
                                                <p><%= orderData.totalAmount %> </p>
                                            </td>

                                            <td>
                                                <p><%= product.Status %> </p>
                                            </td>

                                            <td>
                                                <% if(product.Status != 'Delivered' && product.Status != 'Cancelled' && product.Status != 'Return'){ %>
                                                    
                                                <button class="btn btn-danger p-1" type="button"
                                                    onclick="changeStatus('<%= orderData.orderId %>', '<%= product.productId._id %>')">Change
                                                </button>

                                                <div class="single-element-widget mt-10">
                                                    
                                                    <div class="default-select" id="default-select_2">
                                                        <select id="orderSatusSelect">
                                                            <option value="Confirmed">Confirmed</option>
                                                            <option value="Shipped">Shipped</option>
                                                            <option value="Delivered">Delivered</option>
                                                            <option value="Cancelled">Cancelled</option> 
                                                        </select>
                                                    </div>
                                                </div>

                                               <% } else if(orderData.approvel== 1 && product.Status == 'Delivered'){%>

                                                <div style="width: 155px; height: 80px; ">
                                                    <p style="margin-left: 40px; margin-bottom: 0px; font-weight: 500; font-size: 18px; color: red;">Resone:-</p>
                                                    <p style=" margin-bottom: 6px;"><%= product.reason %></p>
                                                    
                                                    <button onclick="approve('<%= orderData.orderId %>','<%= product.productId._id %>')" style="margin-left: 14px; border: none; background-color: green; color: white;">approve</button>
                                                    <button onclick="decline('<%= orderData.orderId %>','<%= product.productId._id %>')" style="border: none; background-color: red; color: white;">decline</button>
                                                </div>
                                               <% } %>
                                            </td>
                                        </tr>
                                        <% }); %>
    
                                            <% } %>
    
    
                            </tbody>
    
                        </table>
                    </div>

                </div>

               
            </section>
            
        </main>

        <script>
             function changeStatus(orderId, productId) {
               
                

                const selectStatus = document.getElementById('orderSatusSelect').value;
             
                Swal.fire({
                    title: `Are you sure?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: `Yes`

                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/admin/changeStatus', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                orderId: orderId,
                                productId: productId,
                                status:selectStatus
                            })
                        })
                        .then(response => response.json())
                        .then(data =>{
                            window.location.reload();
                        })

                    }
                })
            }


             // approve

    
        function approve(orderId,productId){


            Swal.fire({
                    title: `Are you sure?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: `Yes`

                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/admin/approve', {
                           

                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                orderId: orderId,
                                productId: productId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.reload();
                            }
                        })

                    }
                })

        }

        // decline  
    

    function decline(orderid,productid){
        Swal.fire({
            title: `Are you sure?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: `Yes`

            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/decline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderId: orderid,
                            productId: productid
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                             window.location.reload();
                         }
                    })

                }
            })

    }


        </script>
        <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="assets/js/vendors/select2.min.js"></script>
        <script src="assets/js/vendors/perfect-scrollbar.js"></script>
        <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- Main Script -->
        <script src="assets/js/main.js" type="text/javascript"></script>




        <%- include("../adminLayouts/footer.ejs") %>